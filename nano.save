#!/bin/bash

EMAIL="kaelan.ms@gmail.com"
USERNAME=k
DOTFILES_REPO="git@github.com:Oasixer/dotfiles.git"
SETUP_PROGRESS_DIR=/home/$USERNAME/temp/install_progress
DISTRO=ubuntu
UDIR=/home/$USERNAME

echo "$USERNAME"

# TODO install python versions, venv, flask, etc
step_gate () {
	TARGET=$1
	CHECK_FILE=$SETUP_PROGRESS_DIR/$TARGET
	sudo -u $USERNAME mkdir -p $SETUP_PROGRESS_DIR
	shift
	if [ ! -f $CHECK_FILE ]; then
		echo "running setup/install step: $TARGET"
		eval "$1" && touch $CHECK_FILE
	else
		echo "skipping step: $TARGET"
	fi
}


install_apt_stuff () {
	apt update # after running this we know shit is updated
	apt install -y \
		vim \
		neovim \
		curl \
		nodejs \
		zsh \
		git \
		xclip \
		snapd \
		flameshot \
		neofetch \
		autokey-gtk \
		g++ \
		libgtk-3-dev \
		libtool \
		gtk-doc-tools \
		gnutls-bin \
		valac \
		intltool \
		libpcre2-dev \
		libglib3.0-cil-dev \
		libgnutls28-dev \
		libgirepository1.0-dev \
		libxml2-utils \
		gperf \
		wget \
		mitmproxy \
		build-essential \
    apt-transport-https \
    ca-certificates \
    gnupg2 \
    software-properties-common
}

install_ohmyzsh () {
    sudo -u $USERNAME sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    sudo -u $USERNAME git clone https://github.com/zsh-users/zsh-completions ${ZSH_CUSTOM:=/home/$USERNAME/.oh-my-zsh/custom}/plugins/zsh-completions
}

install_chrome () {
	wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
	sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
	apt install google-chrome-stable -y
	apt remove firefox-esr -y
}

setup_git () {
	sudo -u $USERNAME ssh-keygen -t ed25519 -C $EMAIL
	eval "$(sudo -u $USERNAME ssh-agent -s)"
	ssh-add /home/$USERNAME/.ssh/id_ed25519
	sudo -u $USERNAME xclip -selection clipboard < /home/$USERNAME/.ssh/id_ed25519.pub
	sudo -u $USERNAME google-chrome-stable https://github.com/settings/ssh/new
	read -n 1 -p "press any letter to continue after adding ssh key to github"

	sudo -u $USERNAME git config --global user.name "Kaelan Moffett-Steinke"
	sudo -u $USERNAME git config --global user.email "kaelan.ms@gmail.com"
}

#install_birame () {
#    sudo -u $USERNAME git clone https://github.com/maniat1k/birame.git /home/$USERNAME/.oh-my-zsh/custom/themes/birame
#    cp /home/$USERNAME/.oh-my-zsh/custom/themes/birame/birame.zsh-theme /home/$USERNAME/.oh-my-zsh/custom/themes/birame.zsh-theme
#}

# install_termite () {
# 	sudo -u $USERNAME git clone https://github.com/thestinger/vte-ng.git
# 	sudo -u $USERNAME echo export LIBRARY_PATH="/usr/include/gtk-3.0:$LIBRARY_PATH"
# 
# 	cd vte-ng
# 	sudo -u $USERNAME ./autogen.sh
# 	sudo -u $USERNAME make
# 	make install
# 	sudo -u $USERNAME git clone --recursive https://github.com/thestinger/termite.git
# 	cd termite
# 	sudo -u $USERNAME make
# 	make install
# 	ldconfig
# 	mkdir -p /lib/terminfo/x
# 	ln -s /usr/local/share/terminfo/x/xterm-termite /lib/terminfo/x/xterm-termite
# 	update-alternatives --install /usr/bin/x-terminal-emulator x-terminal-emulator /usr/local/bin/termite 60
# 
# 	exit
# }
# 
# termite_style () {
# 	cd .config
# 	cd termite-style
# 	sudo -u $USERNAME ./install
# 	echo "Running termite-style. Choose theme=material, font=hack"
# 	sudo -u $USERNAME termite-style
# }

install_snaps () {
    snap install discord
    snap install lotion
    snap install postman
    snap install slack --classic
	snap install alacritty --classic
}

#install_fzf () {
#    sudo -u $USERNAME git clone --depth 1 https://github.com/junegunn/fzf.git /home/$USERNAME/.fzf
#    /home/$USERNAME/.fzf/install
#}

install_spotify () {
    mkdir $UDIR/programs
    cd $UDIR/programs
    curl -sS https://download.spotify.com/debian/pubkey_0D811D58.gpg | apt-key add -
    echo "deb http://repository.spotify.com stable non-free" | tee /etc/apt/sources.list.d/spotify.list
    apt install spotify-client -y
}

setup_dotfiles () {
	cd /home/$USERNAME
  sudo -u $USERNAME git init
  sudo -u $USERNAME git remote add origin $DOTFILES_REPO
  sudo -u $USERNAME mkdir backup
  sudo -u $USERNAME mv .config/mimeapps.list backup_before_dotfiles_merge
  sudo -u $USERNAME mv .config/user-dirs.dirs backup_before_dotfiles_merge
  sudo -u $USERNAME mv .config/user-dirs.locale backup_before_dotfiles_merge
  sudo -u $USERNAME mv .zshrc backup_before_dotfiles_merge
	sudo -u $USERNAME git checkout $BRANCH
	sudo -u $USERNAME git submodule init
	sudo -u $USERNAME git submodule update
	sudo -u $USERNAME git pull
}

install_docker () {
		if [ $DISTRO == "debian" ]; then
			apt-key fingerprint 0EBFCD88
			sudo -u $USERNAME curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
			add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable"
		elif [ $DISTRO == "ubuntu" ]; then
			sudo -u $USERNAME curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
			add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
		fi

    apt-cache policy docker-ce
    apt-get install docker-ce docker-ce-cli containerd.io -y
    curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
    ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
    # curl -sS https://dl.yarnpkg.com/ubuntu/pubkey.gpg | apt-key add -
    usermod -aG docker $USERNAME
}

install_yarn_flake () {
    echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
    apt install yarn -y
    apt install flake8 -y
}

install_nvim () {
  sudo -u $USERNAME mkdir -p /home/$USERNAME/.config
  sudo -u $USERNAME git clone https://github.com/Oasixer/nvim /home/$USERNAME/.config/nvim

}

install_node () {
	echo "just run these:"
	echo 'cd $HOME'
	echo 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash'
	echo 'source .bashrc'
	echo 'nvm install 16.9'
	echo 'nvm use 16.9'
}

# install_alacrity () {
	# echo "#!/bin/sh" >> /usr/bin/start-alacritty
	# echo "/usr/bin/snap run alacritty" >> /usr/bin/start-alacritty
	# chmod --reference=/usr/bin/ls /usr/bin/start-alacritty
	# update-alternatives --install /usr/bin/x-terminal-emulator x-terminal-emulator /usr/bin/start-alacritty 50
	# update-alternatives --config x-terminal-emulator
# }

install_kitty () {
	sudo -u $USERNAME curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
	# Create a symbolic link to add kitty to PATH
	sudo -u $USERNAME ln -s $UDIR/.local/kitty.app/bin/kitty $UDIR/.local

	# Place the kitty.desktop file somewhere it can be found by the OS
	sudo -u $USERNAME cp $UDIR/.local/kitty.app/share/applications/kitty.desktop $UDIR/.local/share/applications/

	# Update the path to the kitty icon in the kitty.desktop file
	sudo -u $USERNAME sed -i "s|Icon=kitty|Icon=$UDIR/.local/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" $UDIR/.local/share/applications/kitty.desktop
	update-alternatives --install /usr/bin/x-terminal-emulator x-terminal-emulator $UDIR/.local/bin/kitty 50
}

if [ $DISTRO == "debian" ]; then
	if [ ! -f $SETUP_PROGRESS_DIR/sudo ]; then
		setup_sudoers
	else
		echo "skipping sudo"
	fi
fi

install_apt_stuff
step_gate ohmyzsh install_ohmyzsh
step_gate chrome install_chrome
step_gate git setup_git
step_gate birame install_birame
#step_gate termite install_termite
#step_gate termite_style termite_style
step_gate fzf install_fzf
step_gate snaps install_snaps
step_gate node install_node
step_gate nvim install_nvim
step_gate docker install_docker
if [ $DISTRO == "debian" ]; then
	step_gate dotfiles setup_dotfiles
fi
